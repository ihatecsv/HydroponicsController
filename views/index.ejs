<!DOCTYPE html>
<html>
	<head>
		<title>Drake's hydroponic controller</title>
		<link rel="stylesheet" href="/css/bootstrap.min.css">
	</head>
	<body>
		<div class="container-fluid">
			<h1>Drake's hydroponic controller</h1>
			<svg width="300" height="300">
				<circle cx="150" cy="150" r="100"></circle>
				<path id="dayTime" fill="none" stroke="#F5C151" stroke-width="20" />
				<path id="nightTime" fill="none" stroke="#2C485D" stroke-width="20" />
				<path id="currentTime" fill="none" stroke="#FFFFFF" stroke-width="20" />
				<path id="pumpTime" fill="none" stroke="#0000FF" stroke-width="10" />
			</svg>
			<h3 id="pumpWaitInfo"></h3>
			<h3 id="pumpInfo"></h3>
			<h3 id="lampWaitInfo"></h3>
			<h3 id="lampInfo"></h3>
			Lamp loop<br>
			<input type="radio" name="lampLoop" id="lampLoopOn"> On 
			<input type="radio" name="lampLoop" id="lampLoopOff"> Off<br>
			Pump loop<br>
			<input type="radio" name="pumpLoop" id="pumpLoopOn"> On 
			<input type="radio" name="pumpLoop" id="pumpLoopOff"> Off<br>
			Lamp<br>
			<input type="radio" name="lamp" id="lampOn"> On 
			<input type="radio" name="lamp" id="lampOff"> Off<br>
			Pump<br>
			<input type="radio" name="pump" id="pumpOn"> On 
			<input type="radio" name="pump" id="pumpOff"> Off<br>
		</div>
		<!--<img style="-webkit-user-select: none;" id="webcam">-->
		<script src="/socket.io/socket.io.js"></script>
		<script src="/js/jquery-3.2.1.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script>
		
		var sunrise = "2017-07-07T08:33:44+00:00";
		var sunset = "2017-07-08T00:21:25+00:00";
		
		var sunriseDate = new Date(sunrise);
		var sunsetDate = new Date(sunset);
		var currentDate = new Date();
		
		var sunriseSecs = sunriseDate.getSeconds() + (60 * (sunriseDate.getMinutes() + (60 * sunriseDate.getHours())));
		var sunsetSecs = sunsetDate.getSeconds() + (60 * (sunsetDate.getMinutes() + (60 * sunsetDate.getHours())));
		var currentSecs = currentDate.getSeconds() + (60 * (currentDate.getMinutes() + (60 * currentDate.getHours())));
		
		function map(x, in_min, in_max, out_min, out_max) { //https://gist.github.com/remy/5213884
			return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
		}
		
		function polarToCartesian(centerX, centerY, radius, angleInDegrees) { //https://stackoverflow.com/a/18473154
			var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
		
			return {
				x: centerX + (radius * Math.cos(angleInRadians)),
				y: centerY + (radius * Math.sin(angleInRadians))
			};
		}
		
		function describeArc(x, y, radius, startAngle, endAngle){
		
			var start = polarToCartesian(x, y, radius, endAngle);
			var end = polarToCartesian(x, y, radius, startAngle);
		
			var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
		
			var d = [
				"M", start.x, start.y, 
				"A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
			].join(" ");
		
			return d;       
		}
		
		let sunriseDegrees = map(sunriseSecs, 0, 86400, 0, 360);
		let sunsetDegrees = map(sunsetSecs, 0, 86400, 0, 360);
		let currentDegrees = map(currentSecs, 0, 86400, 0, 360);
		document.getElementById("dayTime").setAttribute("d", describeArc(150, 150, 100, sunriseDegrees, sunsetDegrees));
		document.getElementById("nightTime").setAttribute("d", describeArc(150, 150, 100, sunsetDegrees, sunriseDegrees));
		document.getElementById("currentTime").setAttribute("d", describeArc(150, 150, 100, currentDegrees-1, currentDegrees+1));
		
		let pumpDegrees = 0;
		setInterval(function(){
			pumpDegrees++;
			if(pumpDegrees == 360){
				pumpDegrees = 0;
			}
			document.getElementById("pumpTime").setAttribute("d", describeArc(150, 150, 120, pumpDegrees-4, pumpDegrees+4));
		}, 10);
		</script>
		<script>
			//$("#webcam").attr("src", "//" + window.location.hostname + ":8081");
			var currentState;
			var resetButtons = function(){
				$("#lampLoopOff").prop("checked", false);
				$("#lampLoopOn").prop("checked", false);
				$("#pumpLoopOff").prop("checked", false);
				$("#pumpLoopOn").prop("checked", false);
				$("#pumpOff").prop("checked", false);
				$("#pumpOn").prop("checked", false);
				$("#lampOff").prop("checked", false);
				$("#lampOn").prop("checked", false);
			}
			
			function formatSeconds(seconds){ //https://stackoverflow.com/a/17781037
				var date = new Date(1970,0,1);
				date.setSeconds(seconds);
				return date.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1");
			}
			
			var socket = io();
			$( "#lampLoopOff" ).click(function() {
				socket.emit('lampLoop', {state: false});
			});
			$( "#lampLoopOn" ).click(function() {
				socket.emit('lampLoop', {state: true});
			});
			$( "#pumpLoopOff" ).click(function() {
				socket.emit('pumpLoop', {state: false});
			});
			$( "#pumpLoopOn" ).click(function() {
				socket.emit('pumpLoop', {state: true});
			});
			$( "#lampOff" ).click(function() {
				socket.emit('lamp', {state: false});
			});
			$( "#lampOn" ).click(function() {
				socket.emit('lamp', {state: true});
			});
			$( "#pumpOff" ).click(function() {
				socket.emit('pump', {state: false});
			});
			$( "#pumpOn" ).click(function() {
				socket.emit('pump', {state: true});
			});
			socket.on('state', function(data){
				currentState = data;
				resetButtons();
				if(data.pumpLoop){
					$("#pumpLoopOn").prop("checked", true);
				}else{
					$("#pumpLoopOff").prop("checked", true);
				}
				if(data.lampLoop){
					$("#lampLoopOn").prop("checked", true);
				}else{
					$("#lampLoopOff").prop("checked", true);
				}
				if(data.pump){
					$("#pumpOn").prop("checked", true);
				}else{
					$("#pumpOff").prop("checked", true);
				}
				if(data.lamp){
					$("#lampOn").prop("checked", true);
				}else{
					$("#lampOff").prop("checked", true);
				}
			});
			socket.on('photoAvailable', function(){
				var d = new Date();
				$('#webcamImg').attr("src", "/webcam?"+d.getTime());
			});
			setInterval(function(){ //quick n dirty
				var time = new Date().getTime();
				
				var pumpTimeLeft = Math.floor((currentState.pumpTime+currentState.pumpDelay - time)/1000);
				var pumpWaitTimeLeft = Math.floor((currentState.pumpWaitTime+currentState.pumpWaitDelay - time)/1000);
				
				var lampTimeLeft = Math.floor((currentState.lampTime+currentState.lampDelay - time)/1000);
				var lampWaitTimeLeft = Math.floor((currentState.lampWaitTime+currentState.lampWaitDelay - time)/1000);
				
				if(pumpTimeLeft > 0 && currentState.pumpLoop){
					$("#pumpInfo").html("Pumping for " + formatSeconds(pumpTimeLeft));
				}else{
					$("#pumpInfo").html("");	
				}
				if(pumpWaitTimeLeft > 0 && currentState.pumpLoop){
					$("#pumpWaitInfo").html("Pump waiting for " + formatSeconds(pumpWaitTimeLeft));
				}else{
					$("#pumpWaitInfo").html("");	
				}
				
				if(lampTimeLeft > 0 && currentState.lampLoop){
					$("#lampInfo").html("Lamp on for " + formatSeconds(lampTimeLeft));
				}else{
					$("#lampInfo").html("");	
				}
				if(lampWaitTimeLeft > 0 && currentState.lampLoop){
					$("#lampWaitInfo").html("Lamp off for " + formatSeconds(lampWaitTimeLeft));
				}else{
					$("#lampWaitInfo").html("");	
				}
			}, 500);
		</script>
	</body>
</html>
